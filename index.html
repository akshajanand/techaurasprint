<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAura | Scenario Sim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #a855f7;
            --secondary: #06b6d4;
            --bg-grad-1: rgba(168, 85, 247, 0.25);
            --bg-grad-2: rgba(6, 182, 212, 0.2);
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body.hacker-mode {
            --primary: #ef4444;
            --secondary: #000000;
            --bg-grad-1: rgba(220, 38, 38, 0.3);
            --bg-grad-2: rgba(0, 0, 0, 0.8);
            --glass-bg: rgba(0, 0, 0, 0.85);
            --glass-border: rgba(220, 38, 38, 0.5);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #030712;
            color: white;
            overflow-x: hidden;
            transition: all 0.5s ease;
        }

        h1, h2, .brand-font { font-family: 'Orbitron', sans-serif; }

        .aura-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 20% 20%, var(--bg-grad-1), transparent 40%),
                radial-gradient(circle at 80% 80%, var(--bg-grad-2), transparent 40%);
            z-index: -1;
            transition: all 0.5s ease;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #ef4444;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ef4444;
        }

        .fade-in { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .scanline {
            width: 100%; height: 2px;
            background: rgba(255,255,255,0.1);
            position: absolute; top: 0; left: 0;
            animation: scan 3s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        .option-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            text-align: left;
        }
        .option-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary);
            transform: translateX(5px);
        }
        .hacker-mode .option-btn:hover {
            background: rgba(220, 38, 38, 0.2);
            border-color: #ef4444;
        }

        .option-btn.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .option-btn.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .score-animation {
            animation: scorePopup 0.6s ease-out;
        }

        @keyframes scorePopup {
            0% { transform: scale(0.5) translateY(0); opacity: 1; }
            100% { transform: scale(1) translateY(-30px); opacity: 0; }
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        @media (max-width: 640px) {
            .glass-panel { border-radius: 0; min-h-screen; }
            h1 { font-size: 1.875rem; }
            h2 { font-size: 1.125rem; }
            .option-btn { padding: 0.75rem; font-size: 0.875rem; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="aura-bg"></div>
    <div class="scanline"></div>

    <div id="app" class="w-full max-w-2xl glass-panel rounded-xl min-h-screen sm:min-h-[650px] flex flex-col relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full p-3 sm:p-6 flex justify-between items-center z-10 pointer-events-none">
            <div class="flex items-center gap-2">
                <i class="ri-radar-line text-white text-lg sm:text-xl"></i>
                <span class="brand-font font-bold text-sm sm:text-lg tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">TechAura</span>
            </div>
            <div id="mode-badge" class="px-2 py-1 rounded text-xs border border-cyan-500 text-cyan-400 font-bold tracking-widest">
                SECURE
            </div>
        </div>

        <!-- HOME SCREEN -->
        <div id="screen-home" class="flex-1 flex flex-col items-center justify-center p-4 sm:p-8 text-center fade-in z-20">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 tracking-tighter">SIMULATION_READY</h1>
            <p class="text-gray-400 mb-6 sm:mb-8 text-xs sm:text-sm">Initialize Neural Security Training</p>

            <div class="w-full space-y-4 sm:space-y-6">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <span class="text-xs text-gray-500 uppercase">Standard</span>
                    <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="hacker-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 border-gray-600"/>
                        <label for="hacker-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                    </div>
                    <span class="text-xs text-red-500 font-bold uppercase tracking-widest">HACKER</span>
                </div>

                <input type="text" id="username-input" placeholder="CODENAME" 
                    class="w-full px-4 sm:px-6 py-3 sm:py-4 rounded-lg bg-black/40 border border-white/10 text-center text-lg sm:text-xl tracking-widest text-white focus:border-cyan-400 outline-none transition">
                
                <button onclick="initiateSequence()" class="w-full bg-white text-black font-bold py-3 sm:py-4 rounded-lg hover:bg-gray-200 transition-colors duration-300 brand-font tracking-wider text-sm sm:text-base">
                    ESTABLISH UPLINK
                </button>
            </div>
        </div>

        <!-- LOADING SCREEN -->
        <div id="screen-loading" class="hidden flex-1 flex flex-col items-center justify-center p-4 sm:p-8 text-center fade-in z-20">
            <div class="text-4xl sm:text-5xl mb-4 animate-spin text-cyan-400"><i class="ri-loader-5-line"></i></div>
            <h2 class="text-base sm:text-lg font-bold mb-2">GENERATING SCENARIOS</h2>
            <p class="text-gray-500 text-xs font-mono" id="loading-text">Accessing Global Threat Database...</p>
            <div class="mt-4 text-xs text-gray-600" id="topic-tag">Topic: Loading...</div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="hidden flex-1 flex flex-col p-3 sm:p-6 fade-in h-full pt-16 sm:pt-20">
            <!-- Stats Bar -->
            <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-4 sm:mb-6">
                <div class="bg-white/5 border border-white/10 rounded-lg p-2 sm:p-4 text-center">
                    <div class="text-xs text-gray-500 mb-1">SCORE</div>
                    <div id="score-display" class="text-2xl sm:text-3xl font-bold text-cyan-400">0</div>
                </div>
                <div class="bg-white/5 border border-white/10 rounded-lg p-2 sm:p-4 text-center">
                    <div class="text-xs text-gray-500 mb-1">TIME</div>
                    <div id="timer-display" class="text-2xl sm:text-3xl font-bold text-red-400">60s</div>
                </div>
                <div class="bg-white/5 border border-white/10 rounded-lg p-2 sm:p-4 text-center">
                    <div class="text-xs text-gray-500 mb-1">PROGRESS</div>
                    <div id="progress-display" class="text-2xl sm:text-3xl font-bold text-purple-400">1/20</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar mb-4">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>

            <!-- Scenario Text -->
            <div class="mb-4 sm:mb-6 flex-1">
                <div class="text-xs text-gray-500 mb-2 uppercase tracking-widest">Scenario <span id="q-number">1</span>/20</div>
                <h2 id="scenario-text" class="text-base sm:text-xl font-bold leading-relaxed text-gray-100">
                </h2>
            </div>

            <!-- Options -->
            <div id="options-container" class="flex flex-col gap-2 sm:gap-3 mt-auto">
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="screen-result" class="hidden flex-1 flex flex-col p-0 fade-in h-full overflow-hidden">
            <!-- Score Section -->
            <div class="px-4 sm:px-6 py-4 sm:py-8 text-center bg-gradient-to-b from-white/5 to-transparent">
                <h2 class="text-xs text-gray-500 uppercase tracking-widest mb-2">Mission Debrief</h2>
                <div id="final-score" class="text-5xl sm:text-7xl font-black text-white mb-2 brand-font">0</div>
                <div id="score-category" class="text-lg sm:text-xl font-bold mb-2">...</div>
                <div id="score-details" class="text-xs sm:text-sm text-gray-400"></div>
            </div>

            <!-- Chat Section -->
            <div class="flex-1 bg-black/50 border-t border-white/10 flex flex-col relative overflow-hidden">
                <div class="p-3 border-b border-white/5 flex justify-between bg-white/5 text-xs sticky top-0">
                    <span class="flex items-center gap-2"><i class="ri-robot-line"></i> TechAura Analysis</span>
                    <button onclick="resetGame()" class="hover:text-white text-gray-400 underline text-xs">NEW MISSION</button>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 text-xs sm:text-sm scrollbar-hide"></div>
                <div class="p-3 bg-black/80 border-t border-white/10">
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Ask about your performance..." class="flex-1 bg-black/40 border border-white/10 rounded px-3 py-2 text-white text-xs sm:text-sm focus:border-cyan-400 outline-none">
                        <button onclick="sendChatMessage()" class="text-cyan-400 hover:text-cyan-300 transition"><i class="ri-send-plane-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://hmurtzrapeudgcvnfszb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtdXJ0enJhcGV1ZGdjdm5mc3piIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNjU0MjYsImV4cCI6MjA4MDk0MTQyNn0._6sZ3wjfqtdwgF9NTiF4PkBkMkIeSNvg0EDOYwh8YBM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const TOPICS = [
            "Corporate Phishing", "Deepfake Audio", "Ransomware Negotiation", 
            "Public Wi-Fi Attacks", "Physical Tailgating", "USB Drops", 
            "IoT Camera Hacking", "Social Engineering Calls", "Password Managers", "2FA Fatigue"
        ];

        let state = {
            username: "Guest",
            groqKey: null,
            score: 0,
            timer: 60,
            qIndex: 0,
            interval: null,
            questions: [],
            isHackerMode: false,
            chatContext: [],
            answers: [],
            startTime: null
        };

        const els = {
            screens: { home: document.getElementById('screen-home'), loading: document.getElementById('screen-loading'), game: document.getElementById('screen-game'), result: document.getElementById('screen-result') },
            input: document.getElementById('username-input'),
            toggle: document.getElementById('hacker-toggle'),
            modeBadge: document.getElementById('mode-badge'),
            scenarioText: document.getElementById('scenario-text'),
            optionsBox: document.getElementById('options-container'),
            loadingTopic: document.getElementById('topic-tag')
        };

        els.toggle.addEventListener('change', (e) => {
            state.isHackerMode = e.target.checked;
            if(state.isHackerMode) {
                document.body.classList.add('hacker-mode');
                els.modeBadge.innerText = "HACKER";
                els.modeBadge.className = "px-2 py-1 rounded text-xs border border-red-500 text-red-500 font-bold tracking-widest";
            } else {
                document.body.classList.remove('hacker-mode');
                els.modeBadge.innerText = "SECURE";
                els.modeBadge.className = "px-2 py-1 rounded text-xs border border-cyan-500 text-cyan-400 font-bold tracking-widest";
            }
        });

        (async function init() {
            try {
                const { data } = await supabase.from('app_config').select('key_value').eq('key_name', 'groq_api_key').single();
                if(data) state.groqKey = data.key_value;
            } catch(e) { console.error("DB Error", e); }
        })();

        function show(id) {
            Object.values(els.screens).forEach(el => el.classList.add('hidden'));
            els.screens[id].classList.remove('hidden');
        }

        async function initiateSequence() {
            if(!els.input.value.trim()) return els.input.focus();
            state.username = els.input.value.trim();
            state.answers = [];
            show('loading');

            const t1 = TOPICS[Math.floor(Math.random() * TOPICS.length)];
            const t2 = TOPICS[Math.floor(Math.random() * TOPICS.length)];
            els.loadingTopic.innerText = `Focus: ${t1} & ${t2}`;

            await generateScenarios(t1, t2);
            startGame();
        }

        async function generateScenarios(t1, t2) {
            if(!state.groqKey) {
                console.error("No API key available");
                alert("API key not configured. Please check your Supabase setup.");
                show('home');
                return;
            }

            const difficulty = state.isHackerMode ? 'EXPERT' : 'INTERMEDIATE';
            
            const prompt = `Create 20 ${difficulty} cybersecurity quiz questions about ${t1} and ${t2}.

For each question:
1. Write a scenario
2. Create 3 options (one correct, two wrong)
3. Mark which is correct (0, 1, or 2)
4. Explain why it's correct

Return as JSON array ONLY. No extra text.

[{"q":"scenario text","options":["option A","option B","option C"],"correctIndex":0,"explanation":"why A is correct"}]

${state.isHackerMode ? 'Expert: Very tricky, similar options, requires deep knowledge' : 'Intermediate: Practical, realistic, moderate difficulty'}

Make all text short. Return ONLY the JSON array.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${state.groqKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: prompt }],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if(!res.ok) {
                    const errorData = await res.json();
                    console.error("API Error:", errorData);
                    alert("Error generating scenarios: " + (errorData.error?.message || "Unknown error"));
                    show('home');
                    return;
                }

                const json = await res.json();
                let content = json.choices[0].message.content;
                
                // Clean up JSON response
                content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                
                // Remove problematic characters
                content = content.replace(/[\r\n\t]/g, ' ');
                content = content.replace(/\s+/g, ' ');
                
                // Fix common JSON issues
                content = content.replace(/,\s*}/g, '}'); // Remove trailing commas
                content = content.replace(/,\s*]/g, ']'); // Remove trailing commas in arrays
                content = content.replace(/:\s*'/g, ':"'); // Replace single quotes with double
                content = content.replace(/'\s*,/g, '",'); // End quoted strings properly
                content = content.replace(/"\s*"/g, '"'); // Remove duplicate quotes
                
                // Escape unescaped quotes in strings
                content = content.replace(/": "([^"]*)"([^"]*?)"/g, '": "$1\\"$2"');
                
                let parsed;
                try {
                    parsed = JSON.parse(content);
                } catch(parseErr) {
                    console.log("Failed to parse, attempting extraction...");
                    // Extract just the array
                    const arrayMatch = content.match(/\[\s*\{[\s\S]*\}\s*\]/);
                    if(arrayMatch) {
                        let arrayStr = arrayMatch[0];
                        // Remove any text before [ or after ]
                        arrayStr = arrayStr.substring(arrayStr.indexOf('['), arrayStr.lastIndexOf(']') + 1);
                        parsed = JSON.parse(arrayStr);
                    } else {
                        throw new Error("Could not extract valid JSON from response: " + parseErr.message);
                    }
                }
                
                if(!Array.isArray(parsed) || parsed.length !== 20) {
                    throw new Error(`Expected 20 scenarios, got ${parsed.length}`);
                }
                
                parsed.forEach((q, idx) => {
                    if(!q.q || !Array.isArray(q.options) || q.options.length !== 3 || q.correctIndex === undefined) {
                        throw new Error(`Scenario ${idx} has invalid structure`);
                    }
                    // Validate correctIndex is within range
                    if(typeof q.correctIndex !== 'number' || q.correctIndex < 0 || q.correctIndex > 2) {
                        q.correctIndex = 0; // Fallback to first option
                    }
                    // Ensure explanation exists
                    if(!q.explanation) {
                        q.explanation = `Option ${String.fromCharCode(65 + q.correctIndex)} is the correct answer.`;
                    }
                });
                
                // Double-check we got valid questions
                if(parsed.length < 20) {
                    throw new Error(`Only got ${parsed.length} questions, need 20`);
                }
                
                state.questions = parsed;
            } catch(e) {
                console.error("Generation Error", e);
                alert("Error generating scenarios: " + e.message);
                show('home');
            }
        }

        function startGame() {
            if(!state.questions || state.questions.length === 0) {
                alert("Failed to load scenarios. Please try again.");
                show('home');
                return;
            }

            state.score = 0;
            state.qIndex = 0;
            state.timer = state.isHackerMode ? 30 : 60;
            state.startTime = Date.now();
            
            document.getElementById('score-display').innerText = "0";
            document.getElementById('timer-display').innerText = state.timer + "s";
            document.getElementById('progress-display').innerText = "1/20";
            
            show('game');
            renderQ();

            state.interval = setInterval(() => {
                state.timer--;
                document.getElementById('timer-display').innerText = state.timer + "s";
                if(state.timer <= 0) endGame();
            }, 1000);
        }

        function renderQ() {
            const q = state.questions[state.qIndex];
            els.scenarioText.innerText = q.q;
            document.getElementById('q-number').innerText = (state.qIndex + 1);
            document.getElementById('progress-display').innerText = (state.qIndex + 1) + "/20";
            document.getElementById('progress-fill').style.width = ((state.qIndex + 1) / 20 * 100) + "%";

            els.optionsBox.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "option-btn p-3 sm:p-4 rounded-lg w-full text-xs sm:text-sm font-bold flex items-start sm:items-center gap-3";
                btn.innerHTML = `<span class="bg-white/10 w-6 h-6 rounded flex items-center justify-center text-xs flex-shrink-0">${String.fromCharCode(65+idx)}</span> <span>${opt}</span>`;
                btn.onclick = () => handleAnswer(idx, btn);
                els.optionsBox.appendChild(btn);
            });
        }

        function handleAnswer(choiceIndex, btn) {
            const q = state.questions[state.qIndex];
            const isCorrect = choiceIndex === q.correctIndex;

            // Visual feedback
            if(isCorrect) {
                btn.classList.add('correct');
                state.score += state.isHackerMode ? 2 : 1;
                document.getElementById('score-display').innerText = state.score;
                const popup = document.createElement('div');
                popup.className = 'score-animation text-green-400 font-bold text-lg absolute pointer-events-none';
                popup.innerText = '+' + (state.isHackerMode ? '2' : '1');
                btn.parentElement.appendChild(popup);
            } else {
                btn.classList.add('incorrect');
                const correctBtn = Array.from(els.optionsBox.children)[q.correctIndex];
                correctBtn.classList.add('correct');
            }

            // Track answer
            state.answers.push({
                q: q.q,
                userChoice: q.options[choiceIndex],
                correctChoice: q.options[q.correctIndex],
                isCorrect: isCorrect,
                explanation: q.explanation
            });

            // Disable all buttons
            Array.from(els.optionsBox.children).forEach(btn => btn.disabled = true);

            // Next question
            setTimeout(() => {
                state.qIndex++;
                if(state.qIndex >= 20) endGame();
                else renderQ();
            }, 800);
        }

        async function endGame() {
            clearInterval(state.interval);
            const elapsedTime = Math.round((Date.now() - state.startTime) / 1000);
            
            show('result');
            document.getElementById('final-score').innerText = state.score;
            
            let rank = "CIVILIAN";
            let maxScore = state.isHackerMode ? 40 : 20;
            let ratio = state.score / maxScore;
            let accuracy = Math.round((state.score / maxScore) * 100);

            if(ratio > 0.8) rank = state.isHackerMode ? "ELITE NETRUNNER" : "CYBER GUARDIAN";
            else if(ratio > 0.5) rank = "SECURITY ANALYST";
            
            document.getElementById('score-category').innerText = rank;
            document.getElementById('score-category').className = `text-lg sm:text-xl font-bold mb-2 ${state.isHackerMode ? 'text-red-500' : 'text-cyan-400'}`;
            document.getElementById('score-details').innerText = `${accuracy}% Accuracy â€¢ ${elapsedTime}s â€¢ ${state.isHackerMode ? 'HACKER MODE' : 'STANDARD MODE'}`;

            await supabase.from('scores').insert({ username: state.username, score: state.score, category: rank, accuracy: accuracy, mode: state.isHackerMode ? 'hacker' : 'standard' });
            
            // Analyze performance
            const weakAreas = state.answers.filter(a => !a.isCorrect).map(a => a.q);
            const strengths = state.answers.filter(a => a.isCorrect).length;

            state.chatContext = [
                { role: "system", content: `You are TechAura, a cybersecurity expert AI. User ${state.username} completed 20 security scenarios in ${state.isHackerMode ? 'Hacker' : 'Standard'} mode. Score: ${state.score}/${maxScore} (${accuracy}% accuracy). Rank: ${rank}. Time: ${elapsedTime}s.

PERFORMANCE DATA:
- Correct Answers: ${strengths}/20
- Accuracy: ${accuracy}%
- Mode: ${state.isHackerMode ? 'HACKER' : 'STANDARD'}

Provide a detailed analysis:
1. Overall Performance Summary (1-2 sentences)
2. Key Strengths (what they got right)
3. Areas for Improvement (what they got wrong)
4. Specific Recommendations (actionable advice)

Keep responses concise but insightful. Be encouraging but honest.` }
            ];
            
            addChatBubble(`ðŸŽ¯ Analyzing your ${state.isHackerMode ? 'HACKER MODE' : 'STANDARD'} performance...`, 'bot');
            
            // Get AI analysis
            await getInitialAnalysis();
        }

        async function getInitialAnalysis() {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${state.groqKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        messages: state.chatContext, 
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.7,
                        max_tokens: 600
                    })
                });
                const json = await res.json();
                const reply = json.choices[0].message.content;
                
                // Remove initial message
                const history = document.getElementById('chat-history');
                if(history.lastChild) history.lastChild.remove();
                
                addChatBubble(reply, 'bot');
                state.chatContext.push({ role: "assistant", content: reply });
            } catch(e) { 
                console.error("Analysis error:", e);
                addChatBubble("Unable to load analysis. Try asking me about specific scenarios.", 'bot');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;

            addChatBubble(txt, 'user');
            input.value = '';
            state.chatContext.push({ role: "user", content: txt });

            const load = addChatBubble("...", 'bot');
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${state.groqKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        messages: state.chatContext, 
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                const json = await res.json();
                const reply = json.choices[0].message.content;
                load.remove();
                addChatBubble(reply, 'bot');
                state.chatContext.push({ role: "assistant", content: reply });
            } catch(e) { 
                load.innerText = "Connection lost."; 
                console.error("Chat error:", e);
            }
        }

        function addChatBubble(txt, sender) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg max-w-[95%] sm:max-w-[85%] text-xs sm:text-sm ${sender === 'user' ? 'bg-white/10 ml-auto' : 'bg-black/40 border border-white/5 mr-auto'}`;
            div.innerText = txt;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div;
        }

        function resetGame() { show('home'); }
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key==='Enter') sendChatMessage() });
    </script>
</body>
</html>
